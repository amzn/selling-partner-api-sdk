name: Build PHP SDK

on:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-build]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          path: selling-partner-api-sdk
      - uses: actions/checkout@v4
        with:
          repository: amzn/selling-partner-api-models
          path: selling-partner-api-models
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, curl, json, openssl
          tools: composer:v2
          coverage: none
      - name: Download openapi codegen
        working-directory: ./selling-partner-api-sdk/php
        run: curl -O https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.9.0/openapi-generator-cli-7.9.0.jar
      - name: Remove old sdk files
        working-directory: ./selling-partner-api-sdk/php/sdk
        run: rm -r *
      - name: Copy Auth&Auth lib
        run: cp -R selling-partner-api-models/clients/sellingpartner-api-aa-php/src selling-partner-api-sdk/php/sdk/src
      - name: Copy Composer dependencies
        run: cp -R selling-partner-api-models/clients/sellingpartner-api-aa-php/composer.json selling-partner-api-sdk/php
      - name: Execute openapi codegen
        working-directory: ./selling-partner-api-sdk/php
        run: |
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/amazon-warehousing-and-distribution-model/awd_2024-05-09.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\awd && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/aplus-content-api-model/aplusContent_2020-11-01.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\aplusContent && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/application-integrations-api-model/appIntegrations-2024-04-01.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\appIntegrations && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/application-management-api-model/application_2023-11-30.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\applications && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/catalog-items-api-model/catalogItems_2022-04-01.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\catalogItems && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/data-kiosk-api-model/dataKiosk_2023-11-15.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\datakiosk && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/easy-ship-model/easyShip_2022-03-23.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\easyship && \
          # Skipping FBA Inbound Eligibility API due to error in model tags 
          # java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/fba-inbound-eligibility-api-model/fbaInbound.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\fbaInbound && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/fba-inventory-api-model/fbaInventory.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\fbaInventory && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/feeds-api-model/feeds_2021-06-30.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\feeds && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/finances-api-model/financesV0.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\finances\\v0,apiPackage=Api\\finances\\v0 && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/finances-api-model/finances_2024-06-19.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\finances\\v2024_06_19,apiPackage=Api\\finances\\v2024_06_19 && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/fulfillment-inbound-api-model/fulfillmentInboundV0.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\fulfillment\\inbound\\v0,apiPackage=Api\\fulfillment\\inbound\\v0 && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/fulfillment-inbound-api-model/fulfillmentInbound_2024-03-20.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\fulfillment\\inbound\\v2024_03_20,apiPackage=Api\\fulfillment\\inbound\\v2024_03_20 && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/fulfillment-outbound-api-model/fulfillmentOutbound_2020-07-01.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\fulfillment\\outbound,apiPackage=Api\\fulfillment\\outbound\\v2020_07_01 && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/invoices-api-model/InvoicesApiModel_2024-06-19.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\invoices && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/listings-items-api-model/listingsItems_2021-08-01.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\listings\\items,apiPackage=Api\\listings\\items && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/listings-restrictions-api-model/listingsRestrictions_2021-08-01.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\listings\\restrictions,apiPackage=Api\\listings\\restrictions  && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/merchant-fulfillment-api-model/merchantFulfillmentV0.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\merchantFulfillment && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/messaging-api-model/messaging.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\messaging && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/notifications-api-model/notifications.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\notifications && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/orders-api-model/ordersV0.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\orders && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/product-fees-api-model/productFeesV0.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\productFees && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/product-pricing-api-model/productPricingV0.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\pricing\\v0,apiPackage=Api\\pricing\\v0 && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/product-pricing-api-model/productPricing_2022-05-01.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\pricing\\v2022_05_01,apiPackage=Api\\pricing\\v2022_05_01 && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/product-type-definitions-api-model/definitionsProductTypes_2020-09-01.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\productTypeDefinitions && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/replenishment-api-model/replenishment-2022-11-07.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\replenishment && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/reports-api-model/reports_2021-06-30.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\reports && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/sales-api-model/sales.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\sales && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/sellers-api-model/sellers.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\sellers && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/services-api-model/services.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\services && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/shipment-invoicing-api-model/shipmentInvoicingV0.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\invoicing && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/shipping-api-model/shippingV2.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\shipping && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/solicitations-api-model/solicitations.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\solicitations && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/supply-sources-api-model/supplySources_2020-07-01.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\supplySources && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/tokens-api-model/tokens_2021-03-01.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\tokens && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/uploads-api-model/uploads_2020-11-01.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\uploads && \
          # Skipping Vendor DF Inventory API due to error in model tags
          # java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/vendor-direct-fulfillment-inventory-api-model/vendorDirectFulfillmentInventoryV1.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\vendor\\df\\inventory,apiPackage=Api\\vendor\\df\\inventory && \
          # Skipping Vendor DF Orders API due to error in model tags
          # java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/vendor-direct-fulfillment-orders-api-model/vendorDirectFulfillmentOrders_2021-12-28.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\vendor\\df\\orders,apiPackage=Api\\vendor\\df\\orders && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/vendor-direct-fulfillment-payments-api-model/vendorDirectFulfillmentPaymentsV1.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\vendor\\df\\payments,apiPackage=Api\\vendor\\df\\payments && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/vendor-direct-fulfillment-shipping-api-model/vendorDirectFulfillmentShipping_2021-12-28.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\vendor\\df\\shipping,apiPackage=Api\\vendor\\df\\shipping && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/vendor-direct-fulfillment-transactions-api-model/vendorDirectFulfillmentTransactions_2021-12-28.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\vendor\\df\\transactions,apiPackage=Api\\vendor\\df\\transactions && \
          # Skipping Vendor Invoices API due to error in model tags
          # java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/vendor-invoices-api-model/vendorInvoices.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\vendor\\invoices && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/vendor-orders-api-model/vendorOrders.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\vendor\\orders,apiPackage=Api\\vendor\\orders && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/vendor-shipments-api-model/vendorShipments.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\vendor\\shipments,apiPackage=Api\\vendor\\shipments && \
          java -jar openapi-generator-cli-7.9.0.jar generate -i ../../selling-partner-api-models/models/vendor-transaction-status-api-model/vendorTransactionStatus.json -g php -t config/templates -o sdk -c config/config.json --additional-properties=composerVendorName=amazon,composerPackageName=selling-partner-api-aa-php,modelPackage=Model\\vendor\\transactionStatus,apiPackage=Api\\vendor\\transactionStatus
      - name: Create PR
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: Update PHP SDK
          title: 'Update PHP SDK'
          body: |
            Update PHP SDK with latest changes from upstream.
          branch: feature/update-php-sdk
          assignees: nakagleo
          path: ./selling-partner-api-sdk
          token: ${{ secrets.MAFGE_PAT }}

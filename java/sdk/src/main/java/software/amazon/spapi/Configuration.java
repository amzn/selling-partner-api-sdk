/*
 * The Selling Partner API for Amazon External Fulfillment Return Item Processing
 * You can use the Amazon External Fulfillment Return Item Processing API to retrieve, track, and process return items through Amazon's External Fulfillment returns management system.
 *
 * OpenAPI spec version: 2024-09-11
 * Contact: marketplaceapitest@amazon.com
 *
 * NOTE: This class is auto generated by the swagger code generator program.
 * https://github.com/swagger-api/swagger-codegen.git
 * Do not edit the class manually.
 */

package software.amazon.spapi;

import io.github.bucket4j.BandwidthBuilder.BandwidthBuilderBuildStage;
import io.github.bucket4j.BandwidthBuilder.BandwidthBuilderCapacityStage;
import java.time.Duration;
import java.util.List;
import java.util.Map;
import java.util.function.Function;
import okhttp3.OkHttpClient;
import org.yaml.snakeyaml.Yaml;

public class Configuration {
    private final Map<String, List<Integer>> rateLimitConfiguration =
            new Yaml().load(this.getClass().getClassLoader().getResourceAsStream("rate-limits.yml"));
    private OkHttpClient okHttpClient;
    private static Configuration instance;

    private Configuration() {}

    public OkHttpClient getOkHttpClient() {
        if (okHttpClient == null) okHttpClient = new OkHttpClient();
        return okHttpClient;
    }

    public Function<BandwidthBuilderCapacityStage, BandwidthBuilderBuildStage> getLimit(String operation) {
        return limit -> limit.capacity(getValue(operation, 1))
                .refillGreedy(getValue(operation, 0), Duration.ofSeconds(getValue(operation, 2)));
    }

    private Integer getValue(String operation, Integer position) {
        if (rateLimitConfiguration.containsKey(operation)) {
            if (rateLimitConfiguration.get(operation).size() > position) {
                return rateLimitConfiguration.get(operation).get(position);
            }
        }

        return 1;
    }

    public static Configuration get() {
        if (instance == null) {
            instance = new Configuration();
        }
        return instance;
    }
}
